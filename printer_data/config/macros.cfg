[gcode_macro BACKUP_KLIPPER]
description: "Backup Klipper files"
gcode:
    RUN_SHELL_COMMAND: sh /home/pi/klipper-backup/backup.sh

[gcode_macro INPUT_SHAPER_Y_AXIS] 
Description: "test resonant frequencies on the y-axis"
gcode:
    TEST_RESONANCES AXIS=Y

[gcode_macro INPUT_SHAPER_X_AXIS] 
Description: "test resonant frequencies on the x-axis"
gcode:
    TEST_RESONANCES AXIS=X

[gcode_macro RUN_ONE_TEST]
description: Runs exactly ONE iteration of the aggressive validation test.
gcode:
    {% set ACCEL_TO_TEST = params.ACCEL|default(10000)|int %}
    
    G28 ; Home
    
    RESPOND TYPE=command MSG="Setting printer ACCEL to {ACCEL_TO_TEST} for test."
    SET_VELOCITY_LIMIT ACCEL={ACCEL_TO_TEST}
    
    RESPOND TYPE=command MSG="--- Running 1 test run at {ACCEL_TO_TEST} ---"
    
    # This will now correctly use 'validate_iterations: 1' from your config
    AUTO_SPEED_VALIDATE
    
    RESPOND TYPE=command MSG="--- Test run complete. Check 'missed steps'. ---"

[gcode_macro STRESS_TEST_MULTI]
description: Runs a "dumb loop" stress test. (No summary)
gcode:
    {% set ACCEL_TO_TEST = params.ACCEL|default(10000)|int %}
    {% set RUN_COUNT = params.RUNS|default(20)|int %}

    G28 ; Home
    
    RESPOND TYPE=command MSG="Setting printer ACCEL to {ACCEL_TO_TEST} for stress test."
    SET_VELOCITY_LIMIT ACCEL={ACCEL_TO_TEST}
    
    RESPOND TYPE=command MSG="Starting {RUN_COUNT} individual stress test runs..."
    
    {% for i in range(RUN_COUNT) %}
    
        RESPOND TYPE=command MSG="--- Running run {i + 1} of {RUN_COUNT} ---"
        
        # This will also correctly use 'validate_iterations: 1'
        AUTO_SPEED_VALIDATE
    
    {% endfor %}
    
    RESPOND TYPE=command MSG="Iterative stress test complete. Review console log."