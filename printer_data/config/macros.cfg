[gcode_macro BACKUP_KLIPPER]
description: "Backup Klipper files"
gcode:
    RUN_SHELL_COMMAND: sh /home/pi/klipper-backup/backup.sh

[gcode_macro INPUT_SHAPER_Y_AXIS] 
Description: "test resonant frequencies on the y-axis"
gcode:
    TEST_RESONANCES AXIS=Y

[gcode_macro INPUT_SHAPER_X_AXIS] 
Description: "test resonant frequencies on the x-axis"
gcode:
    TEST_RESONANCES AXIS=X

[gcode_macro FIND_MAX_ACCEL_PRECISE]
description: Runs a high-precision acceleration test on X and Y axes.
gcode:
    G28 ; Home all axes first
    
    RESPOND TYPE=command MSG="Starting PRECISE acceleration test for X-Axis..."
    AUTO_SPEED_ACCEL AXIS="x" ACCEL_ACCU=0.01
    
    RESPOND TYPE=command MSG="Starting PRECISE acceleration test for Y-Axis..."
    AUTO_SPEED_ACCEL AXIS="y" ACCEL_ACCU=0.01
    
    RESPOND TYPE=command MSG="Precise acceleration test complete. Check console for results."

[gcode_macro FIND_MAX_ACCEL_STRESS_TEST]
description: Runs a high-iteration stress test on X and Y axes.
gcode:
    G28 ; Home all axes first
    
    RESPOND TYPE=command MSG="Starting 10-iteration STRESS TEST for X-Axis... This will take longer."
    AUTO_SPEED_ACCEL AXIS="x" ACCEL_ACCU=0.01 ITERATIONS=10 MAX_MISSED=0.5
    
    RESPOND TYPE=command MSG="Starting 10-iteration STRESS TEST for Y-Axis... This will take longer."
    AUTO_SPEED_ACCEL AXIS="y" ACCEL_ACCU=0.01 ITERATIONS=10 MAX_MISSED=0.5
    
    RESPOND TYPE=command MSG="Stress test complete. Check console for results."

[gcode_macro FIND_MAX_ACCEL_AGGRESSIVE]
description: Runs a high-iteration, long-move, DIAGONAL stress test.
gcode:
    G28 ; Home all axes first
    
    RESPOND TYPE=command MSG="Starting AGGRESSIVE DIAGONAL test for Y-Axis... (diag_y)"
    AUTO_SPEED_ACCEL AXIS="diag_y" ITERATIONS=10 MAX_MISSED=0.5 MARGIN=10 ACCEL_ACCU=0.01
    
    RESPOND TYPE=command MSG="Starting AGGRESSIVE DIAGONAL test for X-Axis... (diag_x)"
    AUTO_SPEED_ACCEL AXIS="diag_x" ITERATIONS=10 MAX_MISSED=0.5 MARGIN=10 ACCEL_ACCU=0.01
    
    RESPOND TYPE=command MSG="Aggressive diagonal test complete. Check console for results."

[gcode_macro VALIDATE_ACCEL_SETTINGS]
description: Runs an aggressive 'Ellis' box pattern to validate settings.
gcode:
    G28 ; Home all axes
    
    RESPOND TYPE=command MSG="Running AGGRESSIVE VALIDATION pattern. This checks if steps are lost."
    AUTO_SPEED_VALIDATE ITERATIONS=20 MAX_MISSED=0.5 MARGIN=10
    
    RESPOND TYPE=command MSG="Validation complete. Check console for 'missed steps' messages."


[gcode_macro VERIFY_ACCEL_ITERATIVE_STRESS_TEST]
description: Stress-tests a specific accel, checking for failure after EACH iteration.
gcode:
    # --- Get parameters ---
    {% set ACCEL_TO_TEST = params.ACCEL|default(10000)|int %}
    {% set RUN_COUNT = params.ITERATIONS|default(20)|int %}
    
    G28 ; Home
    
    RESPOND TYPE=command MSG="Setting printer ACCEL to {ACCEL_TO_TEST} for stress test."
    # Temporarily set the printer's acceleration for this test
    SET_VELOCITY_LIMIT ACCEL={ACCEL_TO_TEST}
    
    RESPOND TYPE=command MSG="Starting {RUN_COUNT} individual stress test iterations..."
    
    # --- Loop {RUN_COUNT} times ---
    {% for i in range(RUN_COUNT) %}
    
        RESPOND TYPE=command MSG="--- Running iteration {i + 1} of {RUN_COUNT} ---"
        
        # Run the validation test, but only ONE iteration at a time
        # This forces it to home and check for missed steps after every single run.
        AUTO_SPEED_VALIDATE ITERATIONS=1 MAX_MISSED=0.5 MARGIN=10
    
    {% endfor %}
    
    RESPOND TYPE=command MSG="Iterative stress test complete. Review console log for 'missed steps' messages from each iteration."


[gcode_macro STRESS_TEST_BY_RUN]
description: Stress-tests a specific accel, checking for failure after EACH run.
gcode:
    # --- Get parameters ---
    {% set ACCEL_TO_TEST = params.ACCEL|default(10000)|int %}
    # --- We use 'RUNS' to avoid a parameter conflict with 'ITERATIONS' ---
    {% set RUN_COUNT = params.RUNS|default(20)|int %}
    
    G28 ; Home
    
    RESPOND TYPE=command MSG="Setting printer ACCEL to {ACCEL_TO_TEST} for stress test."
    SET_VELOCITY_LIMIT ACCEL={ACCEL_TO_TEST}
    
    RESPOND TYPE=command MSG="Starting {RUN_COUNT} individual stress test runs..."
    
    # --- Loop {RUN_COUNT} times ---
    {% for i in range(RUN_COUNT) %}
    
        RESPOND TYPE=command MSG="--- Running run {i + 1} of {RUN_COUNT} ---"
        
        # Explicitly call with ITERATIONS=1
        # Because the parent macro was called with 'RUNS', Klipper will
        # no longer override this with 'ITERATIONS=50'.
        AUTO_SPEED_VALIDATE ITERATIONS=1 MAX_MISSED=0.5 MARGIN=10
    
    {% endfor %}
    
    RESPOND TYPE=command MSG="Iterative stress test complete. Review console log for 'missed steps' messages from each run."


[gcode_macro STRESS_TEST_PER_RUN]
description: Stress-tests a specific accel, checking for failure after EACH run.
gcode:
    # --- Get parameters ---
    {% set ACCEL_TO_TEST = params.ACCEL|default(10000)|int %}
    {% set RUN_COUNT = params.RUNS|default(20)|int %}
    
    # --- THIS IS THE FIX ---
    # We create a new, local variable. This cannot be
    # overridden by a "ghost" parameter from the original call.
    {% set ITERS_PER_RUN = 1 %} 

    G28 ; Home
    
    RESPOND TYPE=command MSG="Setting printer ACCEL to {ACCEL_TO_TEST} for stress test."
    SET_VELOCITY_LIMIT ACCEL={ACCEL_TO_TEST}
    
    RESPOND TYPE=command MSG="Starting {RUN_COUNT} individual stress test runs..."
    
    # --- Loop {RUN_COUNT} times ---
    {% for i in range(RUN_COUNT) %}
    
        RESPOND TYPE=command MSG="--- Running run {i + 1} of {RUN_COUNT} ---"
        
        # We explicitly pass our new variable.
        # This will now correctly run with ITERATIONS=1 every time.
        AUTO_SPEED_VALIDATE ITERATIONS={ITERS_PER_RUN} MAX_MISSED=0.5 MARGIN=10
    
    {% endfor %}
    
    RESPOND TYPE=command MSG="Iterative stress test complete. Review console log for 'missed steps' messages from each run."