[gcode_macro BACKUP_KLIPPER]
description: "Backup Klipper files"
gcode:
    RUN_SHELL_COMMAND: sh /home/pi/klipper-backup/backup.sh

[gcode_macro INPUT_SHAPER_Y_AXIS] 
Description: "test resonant frequencies on the y-axis"
gcode:
    TEST_RESONANCES AXIS=Y

[gcode_macro INPUT_SHAPER_X_AXIS] 
Description: "test resonant frequencies on the x-axis"
gcode:
    TEST_RESONANCES AXIS=X

[gcode_macro STRESS_TEST_MULTI]
description: Stress-tests a specific accel, checks each run, AND SUMMARIZES.
gcode:
    {% set ACCEL_TO_TEST = params.ACCEL|default(10000)|int %}
    {% set RUN_COUNT = params.RUNS|default(20)|int %}
    
    # --- Variables to store the summary ---
    {% set total_missed_x = [0.0] %}
    {% set total_missed_y = [0.0] %}
    {% set failed_runs = [0] %}

    G28 ; Home
    
    RESPOND TYPE=command MSG="Setting printer ACCEL to {ACCEL_TO_TEST} for stress test."
    SET_VELOCITY_LIMIT ACCEL={ACCEL_TO_TEST}
    
    RESPOND TYPE=command MSG="Starting {RUN_COUNT} individual stress test runs..."
    
    {% for i in range(RUN_COUNT) %}
    
        RESPOND TYPE=command MSG="--- Running run {i + 1} of {RUN_COUNT} ---"
        
        # Run the test
        AUTO_SPEED_VALIDATE
        
        # --- THIS IS THE FIX ---
        # Get the results from the auto_speed STATUS OBJECT
        {% set current_missed_x = printer.auto_speed.missed_x|float %}
        {% set current_missed_y = printer.auto_speed.missed_y|float %}

        # Add to totals (using Klipper's weird list hack)
        {% set _ = total_missed_x.append(total_missed_x.pop() + current_missed_x) %}
        {% set _ = total_missed_y.append(total_missed_y.pop() + current_missed_y) %}

        # Check if this run failed
        {% if current_missed_x > 0.0 or current_missed_y > 0.0 %}
            {% set _ = failed_runs.append(failed_runs.pop() + 1) %}
        {% endif %}
    
    {% endfor %}
    
    # --- Print the final summary ---
    RESPOND TYPE=command MSG="--- STRESS TEST SUMMARY (ACCEL={ACCEL_TO_TEST}) ---"
    RESPOND TYPE=command MSG="Total runs: {RUN_COUNT}"
    RESPOND TYPE=command MSG="Failed runs (any missed steps): {failed_runs[0]}"
    RESPOND TYPE=command MSG="Total missed X steps: {total_missed_x[0]|round(3)}"
    RESPOND TYPE=command MSG="Total missed Y steps: {total_missed_y[0]|round(3)}"

    {% if failed_runs[0] > 0 %}
        RESPOND TYPE=error MSG="TEST FAILED: Missed steps were detected."
    {% else %}
        RESPOND TYPE=command MSG="TEST PASSED: No steps were missed in {RUN_COUNT} runs."
    {% endif %}